name: testRigor

on:
  schedule:
    - cron: '*/10 * * * *'
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Instalar herramientas de correo
        run: sudo apt-get update && sudo apt-get install -y mailutils

      - name: Ejecutar test suite específico de TestRigor
        id: test_rigor
        run: |
          echo "🚀 Ejecutando test suite en TestRigor..."

          curl -X POST \
            -H 'Content-type: application/json' \
            -H 'auth-token: 82e912e5-eadf-4d97-9ada-9014b25b4083' \
            --data '{
              "branch": { "name": "main", "commit": "latest" },
              "fileUrl": "https://raw.githubusercontent.com/fiorem22/tu-repo/main/app.file", 
              "storedValues": { "storedValueName1": "Value" },
              "customName": "Test desde GitHub Actions"
            }' \
            https://api.testrigor.com/api/v1/apps/cropiDiGsc9M755mz/retest

          sleep 10

          while true
          do
            echo ""
            echo "🔁 Verificando estado del test suite..."
            response=$(curl -i -o - -s -X GET 'https://api.testrigor.com/api/v1/apps/cropiDiGsc9M755mz/status' \
              -H 'auth-token: 82e912e5-eadf-4d97-9ada-9014b25b4083' \
              -H 'Accept: application/json')

            code=$(echo "$response" | grep HTTP | awk '{print $2}')
            body=$(echo "$response" | sed -n '/{/,/}/p')
            echo "Status code: $code"
            echo "Response: $body"

            case $code in
              4*|5*)
                echo "❌ Error llamando a la API" > status.txt
                echo "$body" >> status.txt
                echo "FAIL" >> status_flag.txt
                break
                ;;
              200)
                echo "✅ Test finalizado correctamente" > status.txt
                echo "$body" >> status.txt
                echo "SUCCESS" >> status_flag.txt
                break
                ;;
              227|228)
                echo "⌛ Test aún en curso..."
                ;;
              230)
                echo "❌ Test finalizado con fallos" > status.txt
                echo "$body" >> status.txt
                echo "FAIL" >> status_flag.txt
                break
                ;;
              *)
                echo "⚠️ Estado desconocido" > status.txt
                echo "$body" >> status.txt
                echo "FAIL" >> status_flag.txt
                break
                ;;
            esac
            sleep 10
          done

      - name: Enviar correo con resultado
        if: always()
        run: |
          STATUS=$(cat status_flag.txt)
          SUBJECT="Resultado TestRigor: $STATUS"
          TO="fiorem1891@gmail.com"
          mail -s "$SUBJECT" "$TO" < status.txt
