name: testRigor

on:
  schedule:
    - cron: '*/10 * * * *'  # Cada 10 minutos
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Ejecutar test suite espec√≠fico de TestRigor
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "auth-token: d25cb5ba-7b08-4379-bc6b-e1ae6432c35b" \
            --data '{"forceCancelPreviousTesting":true}' \
            https://api.testrigor.com/api/v1/test_suites/cropiDiGsc9M755mz/run

          sleep 10

          while true
          do
            echo ""
            echo "==================================="
            echo "üîÅ Verificando estado del test suite..."
            echo "==================================="
            response=$(curl -i -o - -s -X GET 'https://api.testrigor.com/api/v1/test_suites/cropiDiGsc9M755mz/status' \
              -H 'auth-token: d25cb5ba-7b08-4379-bc6b-e1ae6432c35b' \
              -H 'Accept: application/json')

            code=$(echo "$response" | grep HTTP | awk '{print $2}')
            body=$(echo "$response" | sed -n '/{/,/}/p')
            echo "Status code: $code"
            echo "Response: $body"

            case $code in
              4*|5*)
                echo "‚ùå Error llamando a la API"
                exit 1
                ;;
              200)
                echo "‚úÖ Test finalizado correctamente"
                exit 0
                ;;
              227|228)
                echo "‚åõ Test a√∫n en curso..."
                ;;
              230)
                echo "‚ùå Test finalizado con fallos"
                exit 1
                ;;
              *)
                echo "‚ö†Ô∏è Estado desconocido"
                exit 1
                ;;
            esac
            sleep 10
          done

      - name: Obtener informe del √∫ltimo test run
        run: |
          echo "üîç Obteniendo informe del √∫ltimo test run..."

          # Reemplaz√° con tu Project ID real si lo ten√©s
          PROJECT_ID="TU_PROJECT_ID"

          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.TESTRIGOR_API_KEY }}" \
            "https://app.testrigor.com/api/v1/projects/$PROJECT_ID/test_runs?limit=1")

          STATUS=$(echo "$RESPONSE" | jq -r '.data[0].status')
          REPORT_URL=$(echo "$RESPONSE" | jq -r '.data[0].url')

          echo "üìä Estado del test: $STATUS"
          echo "üìÑ Informe: $REPORT_URL"
